<!-- Third-Party Licenses: JetBrains Mono -->
<!-- Third-Party Licenses: Ace Editor -->
<!-- Third-Party Licenses: Wandbox -->
<!DOCTYPE html>
<html lang="ja">
    <head>
        <meta charset="UTF-8">
        <title>SEdit</title>
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono&display=swap" rel="stylesheet">
        <style>
            body {
                margin: 0;
            }
            .main-flex {
                display: flex;
                flex-direction: row;
                align-items: flex-start;
                height: 80vh;
                min-height: 300px;
            }
            #editor {
                width: 80vw;
                height: 80vh;
                min-width: 300px;
                min-height: 200px;
                border: 1px solid #ccc;
                box-sizing: border-box;
            }
            #status-table th {
                text-align: left;
                padding-right: 8px;
            }
            #side-area {
                width: 20vw;
                min-width: 160px;
                margin-left: 8px;
                margin-right: 8px;
                display: flex;
                flex-direction: column;
                align-items: stretch;
            }
            #input-stdin-area {
                display: flex;
                flex-direction: column;
                margin-bottom: 12px;
            }
            #input-stdin-area label {
                margin-bottom: 4px;
            }
            textarea {
                width: 100%;
                height: 80px;
                resize: none;
                size: 14px;
                box-sizing: border-box;
            }
            #apikey {
                height: 24px;
            }
            .button-bar {
                display: flex;
                flex-direction: column;
                gap: 8px;
            }
            .button-bar button {
                width: 100%;
                size: 15px;
                padding: 8px 0;
            }
            #status-table {
                margin-top: 8px;
            }
            .outputs {
                border: solid 2px #000000;
                margin-left: 8px;
                padding: 8px;
            }
            .outputs label {
                weight: bold;
                margin-bottom: 4px;
                display: block;
            }
            #err {
                color: red;
            }
            #out {
                margin-top: 8px;
            }
            
            input[type=checkbox].toggle{
              --size:24px;
              appearance:none;-webkit-appearance:none;
              outline:none;
              display:inline-block;width:calc(var(--size)*1.62);height:var(--size);
              border-radius:calc(var(--size)*.5);
              vertical-align:middle;
              background-color:#666;
              transition:.1s;
            }
             input[type=checkbox].toggle::before{
               content:"";
               display:block;
               width:var(--size);height:var(--size);
               border-radius:50%;
               transform:scale(.85);
               background-color:#ffffff;
               transition:inherit;
            }
             input[type=checkbox]:checked.toggle{
               background-color:rgb(0, 214, 43);
            }
             input[type=checkbox]:checked.toggle::before{
               transform:translateX(calc(var(--size)*.62))scale(.85);
            }
            
            .expect-stdin,.apikey-area {
              visibility: hidden;
            }
            
            /* チェックされたら表示 */
            #checkbox:checked ~ .expect-stdin {
              visibility: visible;
            }
            
            .selectapi select {
                width: 100%;
                font-size: 18px;
                box-sizing: border-box;
                margin-bottom: 12px;
            }
            
        </style>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.2/ace.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.2/ext-language_tools.js"></script>
    </head>
    <body>
        <div class="main-flex">
            <div id="editor"></div>
            <div id="side-area">
                <div class="selectapi">
                    <label for="selectapi">SELECT API</label>
                    <select id="selectapi">
                        <option label="Wandbox - mono-6.12.0.199" value="wandbox"/>
                    </select>
                    <div class="apikey-area">
                        <label>API-KEY</label>
                        <textarea id="apikey" rows="1"></textarea>
                    </div>
                </div>
                <div id="input-stdin-area">
                    <label for="input-stdin">INPUT</label>
                    <textarea id="input-stdin" rows="3"></textarea>
                </div>
                <div id="expect">
                    <label for="checkbox">EXPECT OUTPUT</label>
                    <input type="checkbox" class="toggle" id="checkbox">
                    <div class="expect-stdin">
                        <textarea id="expect-stdin" rows="3"></textarea>
                    </div>
                </div>
                <div class="button-bar">
                    <button id="run-cs">Run C#</button>
                </div>
                <table id="status-table">
                    <tr>
                        <th>Status:</th>
                        <td id="status"></td>
                    </tr>
                    <tr>
                        <th>ExitCode:</th>
                        <td id="exitcode"></td>
                    </tr>
                </table>
            </div>
        </div>
        <!-- OUTPUT以下をmain-flexの外に出す -->
        <br>
        <div class="outputs">
            <label>OUTPUT</label>
            <pre id="err"></pre>
            <pre id="out"></pre></div>
        <script>
            const selectAPI = document.getElementById("selectapi"),
            apikeyArea = document.querySelector(".apikey-area"),
            Stdin = document.getElementById("input-stdin"),
            ExpectStdin = document.getElementById("expect-stdin"),
            checkbox = document.getElementById("checkbox"),
            Status = document.getElementById("status"),
            ExitCode = document.getElementById("exitcode"),
            Err = document.getElementById("err"),
            Out = document.getElementById("out"),
            setMain = document.getElementById("set-main"),
            insertAclib = document.getElementById("insert-aclib"),
            insertStrInput = document.getElementById("insert-str-input"),
            run = document.getElementById("run-cs");
        
            // Editor
            const editor = ace.edit("editor");
            editor.$blockScrolling = Infinity;
            editor.setTheme("ace/theme/dawn");
            editor.getSession().setMode("ace/mode/csharp");
            editor.setFontSize(16);
            editor.session.setUseSoftTabs(true);
            editor.session.setUseWrapMode(true);
            editor.session.setTabSize(4);
            editor.setOptions({
                enableBasicAutocompletion: true,
                enableSnippets: true,
                enableLiveAutocompletion: true,
                fontFamily: "JetBrains Mono, monospace"
            });
        
            function parseCompilerErrors(errorText) {
                const annotations = [];
                const lines = errorText.split('\n');
                const regex = /^(?:\[.*?\])?(.*?)[(:](\d+)[,:](\d+)?\)?:?\s*(error|warning)?\s*:?(.+)?$/;
                for (const line of lines) {
                    const match = regex.exec(line);
                    if (match) {
                        const [, , lineNum, colNum, type, message] = match;
                        const row = parseInt(lineNum, 10) - 1;
                        const column = colNum ? parseInt(colNum, 10) - 1 : 0;
                        annotations.push({
                            row,
                            column,
                            text: message ? message.trim() : "Error",
                            type: (type === "warning") ? "warning" : "error"
                        });
                    }
                }
                return annotations;
            }
        
            async function request(body) {
                editor.getSession().clearAnnotations();
                const selectedAPI = selectAPI.value;
                try {
                    if (selectedAPI === "wandbox") {
                        const res = await fetch("https://wandbox.org/api/compile.json", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify(body)
                        });
                        const json = await res.json();
                        let output = "", error = "", status = "OK", exitCode = "";
                    
                        if (json.program_output) output += json.program_output;
                        if (json.program_error) error += json.program_error;
                        if (json.compiler_output) output += json.compiler_output;
                        if (json.compiler_error) {
                            error += json.compiler_error;
                            const annotations = parseCompilerErrors(json.compiler_error);
                            editor.getSession().setAnnotations(annotations);
                        }
                    
                        if (json.status !== undefined) exitCode = String(json.status);
                        if (json.signal) exitCode += ` (${json.signal})`;
                    
                        if (json.compiler_error?.includes('error')) status = "CE";
                        else if (json.compiler_error?.includes('warning')) status = "WN";
                        else if (json.status != 0) status = "RE";
                    
                        return { status, exitCode, output, error };
                    } else {
                        throw new Error("Unknown API selected");
                    }
                } catch (e) {
                    console.error(e);
                    return {
                        status: "IE",
                        exitCode: "",
                        output: "",
                        error: String(e)
                    };
                }
            }
            editor.session.setValue('using System;using System.Collections.Generic;using System.Diagnostics;using System.Linq;using System.Numerics;using static System.Math;'+
            'using rin = System.String;using vi = System.Collections.Generic.List<int>;using vs = System.Collections.Generic.List<string>;using vvi = System.Collections.Generic.List<System.Collections.Generic.List<int>>;using si = System.Collections.Generic.SortedSet<int>;using qi = System.Collections.Generic.Queue<int>;using dii = System.Collections.Generic.Dictionary<int, int>;using dsi = System.Collections.Generic.Dictionary<string, int>;using mi = System.Collections.Generic.HashSet<int>;\nusing static utils;'+
            '\n\nclass P{\n    public static void Main(string[] args){\n        \n    }\n}\n'+
            'class utils{public static string input()=>Console.ReadLine();public static void print()=>Console.WriteLine();public static void print(object x,rin end)=>Console.Write(x+end);public static void print(object x)=>Console.WriteLine(x);public static void print<T>(List<T>a)=>print(string.Join(" ",a));public static void print<T>(HashSet<T>a)=>print(string.Join(" ",a));public static int rintoint(string s)=>int.Parse(s);public static string yn(int b)=>b>0?"Yes":"No";public static string yn(bool b)=>b?"Yes":"No";public static List<rin>rintovs(rin a)=>a.Split(\' \').ToList();public static List<int>rintovi(rin a)=>rintovs(a).Select(int.Parse).ToList();public static List<int>range(int start,int n)=>Enumerable.Range(start,n).ToList();public static void fin()=>Environment.Exit(0);public static bool ChMin(ref int a,int b){if(a>b){a=b;return true;}return false;}public static bool ChMax(ref int a,int b){if(a<b){a=b;return true;}return false;}}');

            // RUN button
            run.addEventListener("click", async function () {
                const code = editor.getValue();
                const stdin = Stdin.value;
                const expected = ExpectStdin.value;
                const api = selectAPI.value;
            
                Status.textContent = "WJ";
                ExitCode.textContent = "";
                Err.textContent = "";
                Out.textContent = "";
            
                let body = {
                    code,
                    compiler: "mono-6.12.0.199",
                    save: false,
                    options: "mono-optimize",
                    codes: [],
                    "compiler-option-raw": "",
                    description: "",
                    "runtime-option-raw": "",
                    stdin,
                    title: "",
                };
            
                const result = await request(body);
            
                if (checkbox.checked) {
                    Status.textContent = result.status === "OK" && expected.trim() === result.output.trim() ? "AC" : "WA";
                } else {
                    Status.textContent = result.status;
                }
            
                ExitCode.textContent = result.exitCode;
                Err.textContent = result.error;
                Out.textContent = result.output;
            });
        
            // API selection
            /*selectAPI.addEventListener("change", function () {apikeyArea.style.visibility = "visible";});*/
        </script>
    </body>
</html>






